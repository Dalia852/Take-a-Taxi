<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Main Page</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f0f2f5;
    padding-top: 70px; /* space for fixed navbar */
  }

  /* Busy Label */
  .busy-label {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    background-color: #ff9800;
    color: white;
    margin-left: 0.5rem;
  }

  /* Cards */
  .card {
    border-radius: 15px;
  }
</style>
</head>
<body>




{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; padding-top: 70px; }
  .busy-label { display: inline-block; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; background-color: #ff9800; color: white; margin-left: 0.5rem; }
  .card { border-radius: 15px; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top shadow">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Welcome, {{driver.first_name}} {{driver.last_name}}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#driverNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="driverNavbar">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'about_us' 'driver' driver.id %}">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'about_us' 'driver' driver.id %}">About Us</a>
        </li>
      </ul>
      <div class="d-flex">
        <a href="{% url 'user_logout' %}" class="btn btn-outline-light">Logout</a>
      </div>
    </div>
  </div>
</nav>

<div class="container my-4">

  <!-- Driver Status -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">Taxi Info</h5>
      <p><strong>Status:</strong> {{driver.status|capfirst}}</p>

      <div class="d-flex gap-2">
        <a href="{% url 'set_driver_status' driver.id 'available' %}" class="btn btn-success">Available</a>
        <a href="{% url 'set_driver_status' driver.id 'unavailable' %}" class="btn btn-secondary">Unavailable</a>
        {% if driver.status == 'busy' %}
          <span class="busy-label">Busy</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Ride Requests -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Pending Ride Requests</h5>

     <div class="requests-container"></div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const acceptUrlBase = "{% url 'accept_request' 0 %}".replace("0/", "");
  const rejectUrlBase = "{% url 'reject_request' 0 %}".replace("0/", "");

  function fetchRequests() {
    $.ajax({
      url: "{% url 'driver_pending_requests_api' driver.id %}",
      method: "GET",
      success: function(data) {
        let container = $(".card-body .requests-container");
        if (container.length === 0) {
          $(".card-body").append('<div class="requests-container"></div>');
          container = $(".card-body .requests-container");
        }

        container.empty(); // clear old requests

        if (data.requests.length > 0) {
          data.requests.forEach(req => {
            container.append(`
              <div class="border p-3 rounded mb-3">
                <p><strong>Customer:</strong> ${req.customer}</p>
                <p><strong>Pickup:</strong> ${req.pickup}</p>
                <p><strong>Dropoff:</strong> ${req.dropoff}</p>
                <div class="d-flex gap-2">
                  <form method="post" action="${acceptUrlBase}${req.id}/">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-success">Accept</button>
                  </form>
                  <form method="post" action="${rejectUrlBase}${req.id}/">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-danger">Reject</button>
                  </form>
                </div>
              </div>
            `);
          });
        } else {
          container.html("<p class='text-muted'>No pending ride requests.</p>");
        }
      }
    });
  }

  setInterval(fetchRequests, 5000);
  fetchRequests();
</script>



</body>
</html>
